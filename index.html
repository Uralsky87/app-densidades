<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Densidades</title>

  <!-- Vista adaptada a móvil -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="styles.css" />
  <link rel="manifest" href="manifest.json" />
</head>
<body>

  <!-- BANNER DE ACTUALIZACIÓN -->
  <div id="updateBanner" class="update-banner hidden" aria-live="polite">
    <span>Hay una nueva versión disponible.</span>
    <button id="btnUpdateApp" type="button">Actualizar</button>
  </div>

  <!-- CABECERA CON TÍTULO + BOTÓN INFO -->
  <header class="app-header">
    <h1>Densidades</h1>
    <div class="menu-wrapper">
      <button id="btnMenu" class="icon-btn" aria-label="Menú">☰</button>
      <div id="menuDropdown" class="menu-dropdown hidden" role="menu" aria-label="Menú rápido">
        <button id="btnOpenSettings" type="button" role="menuitem">Ajustes</button>
        <button id="btnOpenCalcRapida" type="button" role="menuitem">Calculadora</button>
        <button id="btnOpenHistorial" type="button" role="menuitem">Historial</button>
      </div>
    </div>
  </header>

  <!-- MENÚ PRINCIPAL -->
  <div id="main-menu" class="card">
    <div class="menu-grid">
      <div class="menu-item">
        <button class="menu-card" data-target="calc">
          <span class="menu-card-title">Calculadora MP</span>
        </button>
        <span class="menu-card-desc">Calcula el volumen de una Materia Prima.</span>
      </div>
      <div class="menu-item">
        <button class="menu-card" data-target="disolucion">
          <span class="menu-card-title">Disolución</span>
        </button>
        <span class="menu-card-desc">Calcula el agua total de una mezcla de MP.</span>
      </div>
      <div class="menu-item">
        <button class="menu-card" data-target="productos">
          <span class="menu-card-title">Materias primas</span>
        </button>
        <span class="menu-card-desc">Agrega MP y sus densidades para cálculos rápidos.</span>
      </div>
    </div>
  </div>

  <!-- ================= CALCULADORA ================= -->
  <div id="tab-calc" class="tab">
    <div class="card">
      <button class="back-btn">← Menú principal</button>
      <h2>Calculadora MP</h2>
      <p class="hint-text">Selecciona o añade una MP y apunta su masa (g) para obtener el volumen que ocupa.</p>

      <label for="producto">Producto:</label>
      <select id="producto"></select>

      <div class="manual-materia-row">
        <button id="btnMateriaManual" type="button" class="manual-materia-btn action-btn action-btn-soft">+ Materia manual</button>
        <div id="materiaManualInfo" class="manual-materia hidden">
          <span id="materiaManualText"></span>
          <button id="btnEliminarMateriaManual" type="button" class="manual-materia-remove" aria-label="Eliminar materia manual">×</button>
        </div>
      </div>

      <label for="valor">Masa (g):</label>
      <input type="number" id="valor" placeholder="Introduce masa en g" />

      <button id="btnCalcular" class="action-btn">Calcular</button>

      <!-- Mensajes de error-->
      <div id="error" class="error" aria-live="polite"></div>

      <!-- Resultado -->
      <div id="resultado" class="resultado" aria-live="polite"></div>
    </div>
  </div>

 <!-- ================= DISOLUCIÓN ================= -->
  <div id="tab-disolucion" class="tab">
    <div class="card">
      <button class="back-btn">← Menú principal</button>
      <h2>Disolución</h2>

      <button id="btnResetDisolucion" type="button" class="action-btn action-btn-soft">Reset</button>

      <label for="aguaCsp">Volumen final CSP de agua:</label>
      <input type="number" id="aguaCsp" placeholder="Volumen total final en mL" />
      <small class="hint-text">El volumen final de la disolución se expresa en mL.</small>

      <h3>Materias primas</h3>
      <p class="hint-text">Añade las materias primas que forman parte de la disolución.</p>

      <div id="materiasContainer"></div>

      <button id="btnAnadirMateria" type="button" class="action-btn">+ Añadir materia prima</button>

      <div id="disolucionError" class="error" aria-live="polite"></div>

      <button id="btnCalcularDisolucion" type="button" class="action-btn">Calcular</button>

      <div id="disolucionResultado" class="resultado" aria-live="polite"></div>

      <button id="btnDetallesDisolucion" type="button" class="action-btn action-btn-soft hidden">Detalles</button>
      <div id="detallesDisolucion" class="detalles hidden"></div>
    </div>
  </div>

  <!-- ================= CALCULADORA ================= -->
  <div id="tab-calcrapida" class="tab">
    <div class="card">
      <button class="back-btn">← Menú principal</button>
      <h2>Calculadora</h2>

      <!-- Pantalla de la calculadora -->
      <div id="calcDisplay" class="calc-display">0</div>

      <!-- Layout: teclado numérico + operaciones a la derecha -->
      <div class="calc-layout">
        <div class="calc-keypad">
          <button class="calc-btn" data-calc-num="7">7</button>
          <button class="calc-btn" data-calc-num="8">8</button>
          <button class="calc-btn" data-calc-num="9">9</button>

          <button class="calc-btn" data-calc-num="4">4</button>
          <button class="calc-btn" data-calc-num="5">5</button>
          <button class="calc-btn" data-calc-num="6">6</button>

          <button class="calc-btn" data-calc-num="1">1</button>
          <button class="calc-btn" data-calc-num="2">2</button>
          <button class="calc-btn" data-calc-num="3">3</button>

          <button class="calc-btn" id="calcDot">.</button>
          <button class="calc-btn" data-calc-num="0">0</button>
          <button class="calc-btn calc-clear-btn" id="calcClear">C</button>
        </div>

        <div class="calc-ops">
          <button class="calc-op-btn" data-calc-op="+">+</button>
          <button class="calc-op-btn" data-calc-op="-">−</button>
          <button class="calc-op-btn" data-calc-op="*">×</button>
          <button class="calc-op-btn" data-calc-op="/">÷</button>
          <button class="calc-op-btn calc-equals-btn" id="calcEquals">=</button>
        </div>
      </div>

      <h3>Historial</h3>
      <ul id="calcHistory" class="calc-history">
        <li class="calc-history-empty">No hay operaciones todavía.</li>
      </ul>
    </div>
  </div>

  <!-- ================= PRODUCTOS ================= -->
  <div id="tab-productos" class="tab">
    <div class="card">
      <button class="back-btn">← Menú principal</button>
      <h2>Materias primas</h2>

      <button id="btnNuevoProducto" class="action-btn">Añadir materia prima</button>

      <table id="tablaProductos">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Densidad</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody><!-- Se rellena con JS --></tbody>
      </table>
    </div>
  </div>

   <!-- ================= HISTORIAL ================= -->
  <div id="tab-historial" class="tab">
    <div class="card">
      <button class="back-btn">← Menú principal</button>
      <h2>Historial</h2>

      <nav class="subnav">
        <button class="subtab-btn active-subtab action-btn" data-subtab="calculos">Cálculos</button>
        <button class="subtab-btn" data-subtab="disoluciones">Disoluciones</button>
      </nav>

      <!-- Subpestaña: Historial de cálculos -->
      <div id="subtab-calculos" class="subtab-panel active-subtab-panel">
        <button id="btnBorrarHistorialCalculos" class="action-btn action-btn-soft">Borrar historial</button>

        <table id="tablaHistorialCalculos">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>M.P.</th>
              <th>Entrada</th>
              <th>Resultado</th>
            </tr>
          </thead>
          <tbody>
            <!-- Aquí se rellena con JS -->
          </tbody>
        </table>
      </div>

      <!-- Subpestaña: Historial de disoluciones -->
      <div id="subtab-disoluciones" class="subtab-panel">
        <button id="btnBorrarHistorialDisoluciones" class="action-btn action-btn-soft">Borrar historial de disoluciones</button>

        <table id="tablaHistorialDisoluciones">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Volumen final</th>
              <th>Materias primas</th>
              <th>Agua CSP</th>
            </tr>
          </thead>
          <tbody>
            <!-- Aquí se rellena con JS -->
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- MODAL DE AJUSTES -->
  <div id="settings-modal" class="modal hidden">
    <div class="card modal-card">
      <h2>Ajustes</h2>

      <h3>Tema</h3>
      <div class="settings-row">
        <span>Modo</span>
        <div class="theme-toggle">
          <button id="btnThemeLight" type="button" class="theme-btn">Claro</button>
          <button id="btnThemeDark" type="button" class="theme-btn">Oscuro</button>
        </div>
      </div>

      <h3>Datos</h3>
      <button id="btnExportarDatos" class="menu-btn action-btn">Exportar datos</button>
      <button id="btnImportarDatos" class="menu-btn small-btn action-btn action-btn-soft">Importar datos</button>
      <input type="file" id="inputImportarDatos" accept="application/json" style="display:none" />

      <details class="settings-details">
        <summary class="settings-summary">Información</summary>
        <div class="settings-details-content">
          <p class="info-text">
            Esta aplicación es una herramienta de apoyo para cálculos de volumen y densidad.
            Los resultados dependen de la corrección de los datos introducidos por el usuario
            (densidades, cantidades, unidades, etc.).
          </p>
          <p class="info-text">
            La responsabilidad final de verificar los cálculos y de la preparación recae siempre
            en el técnico o profesional que realiza la fórmula y en los procedimientos
            de control del laboratorio.
          </p>
        </div>
      </details>

      <button id="btnCerrarSettings" class="action-btn action-btn-soft">Cerrar</button>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    if ("serviceWorker" in navigator) {
      const updateBanner = document.getElementById("updateBanner");
      const btnUpdateApp = document.getElementById("btnUpdateApp");
      let waitingWorker = null;

      const showUpdateBanner = () => {
        if (updateBanner) updateBanner.classList.remove("hidden");
      };

      navigator.serviceWorker.register("service-worker.js")
        .then(reg => {
          console.log("SW registrado");

          if (reg.waiting) {
            waitingWorker = reg.waiting;
            showUpdateBanner();
          }

          reg.addEventListener("updatefound", () => {
            const newWorker = reg.installing;
            if (!newWorker) return;
            newWorker.addEventListener("statechange", () => {
              if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
                waitingWorker = newWorker;
                showUpdateBanner();
              }
            });
          });
        })
        .catch(err => console.error("SW error:", err));

      if (btnUpdateApp) {
        btnUpdateApp.addEventListener("click", () => {
          if (waitingWorker) {
            waitingWorker.postMessage({ type: "SKIP_WAITING" });
          }
        });
      }

      navigator.serviceWorker.addEventListener("controllerchange", () => {
        window.location.reload();
      });
    }
  </script>
</body>
</html>